# 画布标注类型集成指南

## 概述

我们已经成功将图片标注功能集成到了工作流参数系统中。现在您可以在输入节点的参数中添加一个新的 `list_of_values` 类型，该类型专门用于存储图片标注的坐标数据。

## 功能特性

### 📊 新增参数类型

- **类型名称**: `list_of_values`
- **显示名称**: "标注坐标"
- **数据格式**: 二维点坐标数组 `Point[][]`
- **UI 表现**: 按钮 + 模态框的形式

### 🎨 用户交互

1. **状态显示**: 显示当前标注对象数量和类型统计
2. **快速操作**: 一键清除所有标注
3. **模态框编辑**: 点击按钮打开全屏标注界面
4. **数据预览**: 可折叠的坐标数据预览

## 使用方法

### 1. 在工作流中添加标注参数

当您创建或编辑一个输入节点时：

1. 点击添加新参数
2. 设置参数名称（例如：`region_annotations`）
3. 从参数类型下拉菜单中选择 **"标注坐标"**
4. 系统会自动为该参数创建一个标注界面

### 2. 进行图片标注

1. 点击 **"开始标注"** 按钮
2. 在弹出的模态框中：
   - 上传图片或视频文件
   - 或者使用摄像头快照（需要配置 workspace 和 camera ID）
3. 选择绘制模式：
   - **选择**: 编辑已有标注
   - **画线**: 绘制线条标注
   - **画多边形**: 绘制多边形区域
4. 完成标注后点击 **"保存标注"**

### 3. 数据格式

标注数据以以下格式存储：

```typescript
[
  [
    { x: 100, y: 200 },
    { x: 300, y: 400 }
  ], // 线条：两个点
  [
    // 多边形：多个点
    { x: 50, y: 50 },
    { x: 150, y: 50 },
    { x: 100, y: 150 }
  ]
];
```

## 技术实现详情

### 📁 新增文件

```
custom-fields/
├── annotation-dialog-field.tsx    # 标注对话框字段组件
└── image-annotation/               # 图片标注组件库
    ├── types.ts                    # 类型定义
    ├── utils.ts                    # 工具函数
    ├── toolbar.tsx                 # 操作栏
    ├── canvas.tsx                  # 画布组件
    ├── index.tsx                   # 主组件
    ├── image-annotation-field.tsx  # 包装组件
    └── example.tsx                 # 示例代码
```

### 🔧 修改的文件

1. **`constants/init-data.ts`**:

   - 在参数类型枚举中添加 `'list_of_values'`
   - 在 `anyOf` 配置中添加对应的 schema 定义

2. **`param-type-field.tsx`**:

   - 添加新类型到 `TYPE_OPTIONS`
   - 在 `getDefaultValueForType` 中处理默认值
   - 在 `renderValueInput` 中集成 `AnnotationDialogField`

3. **`node-detail.tsx`**:
   - 导入 `AnnotationDialogField` 组件
   - 在 `customFields` 中注册新字段
   - 在 uiSchema 生成逻辑中添加字段类型检测

### 🎯 集成点

- **字段检测**: 通过 `x-field-type: 'annotation-dialog'` 标识
- **自动注册**: 在表单渲染时自动应用自定义字段
- **数据同步**: 与表单系统无缝集成，支持撤销/重做

## 最佳实践

### 1. 参数命名

建议使用描述性的参数名称：

- `detection_regions` - 检测区域
- `roi_annotations` - 感兴趣区域标注
- `exclusion_zones` - 排除区域
- `measurement_lines` - 测量线条

### 2. 工作流设计

- 在输入节点中定义标注参数
- 在处理节点中引用这些坐标数据
- 考虑坐标系的统一性（像素坐标 vs 相对坐标）

### 3. 性能考虑

- 复杂多边形会增加数据量
- 建议限制标注对象数量（默认最大 20 个）
- 大图片处理时考虑缩放比例

## 故障排除

### 常见问题

1. **模态框无法打开**

   - 检查 Dialog 组件是否正确安装
   - 确认没有 CSS 层级冲突

2. **标注数据丢失**

   - 确保在标注完成后点击了 "保存标注" 按钮
   - 检查表单的 onChange 事件是否正常触发

3. **摄像头功能不工作**
   - 需要提供有效的 `workspaceId` 和 `cameraId`
   - 确认后端 API 可访问

### 调试技巧

- 使用 "查看坐标数据" 功能检查数据格式
- 在浏览器开发者工具中查看表单数据
- 检查网络请求确认 API 调用正常

## 扩展性

该系统设计为可扩展的：

- **新的标注类型**: 可以添加圆形、椭圆等形状
- **高级功能**: 可以集成测量、角度计算等功能
- **数据导出**: 支持多种格式的坐标数据导出
- **集成外部工具**: 可以与其他图像处理库集成

## 版本历史

- **v1.0.0**: 初始实现，支持线条和多边形标注
- 支持图片和视频文件上传
- 集成摄像头快照功能
- 完整的编辑和拖拽功能
